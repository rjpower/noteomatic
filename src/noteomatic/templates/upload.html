<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Notes</title>
    <link rel="stylesheet" href="/static/upload.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body>
    <div class="container">
        <nav class="mobile-nav">
            <a href="/browse">Browse</a>
            <a href="/">Home</a>
            <a href="/tags">Tags</a>
            <a href="/search">Search</a>
        </nav>
        <div class="upload-section">
            <div class="mobile-controls">
                <button onclick="captureImage('camera')" class="btn">
                    <img src="/static/icons/camera.svg" alt="Camera" class="btn-icon">
                    Take Photo
                </button>
                <button onclick="captureImage('library')" class="btn">
                    <img src="/static/icons/photo.svg" alt="Library" class="btn-icon">
                    Library
                </button>
            </div>

            <div class="drop-zone">
                <span class="drop-zone__prompt">Drop PDF or image file here or click to upload</span>
                <input type="file" name="pdf" class="drop-zone__input" accept=".pdf,.png,.jpg,.jpeg,.heic" hidden>
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input">
                    <textarea id="user-input" placeholder="Ask me anything about your notes..." rows="1"></textarea>
                    <button onclick="sendMessage()" class="btn">Send</button>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth <= 600;
        }

        function addMessage(message, isUser = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            if (isUser) {
                messageDiv.textContent = message;
            } else {
                const temp = document.createElement('div');
                temp.innerHTML = DOMPurify.sanitize(message);
                messageDiv.innerHTML = temp.innerHTML;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            addMessage(message);
            userInput.value = '';
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                const responseText = data.success ? data.response : 'Error: ' + data.error;
                
                // Create a temporary div to safely parse HTML
                const temp = document.createElement('div');
                temp.innerHTML = DOMPurify.sanitize(responseText);
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = temp.innerHTML;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                addMessage('Error sending message: ' + error, false);
            }
        }

        function captureImage(source) {
            const input = document.querySelector('.drop-zone__input');
            input.removeAttribute('capture');
            
            if (source === 'camera') {
                input.setAttribute('capture', 'environment');
            }
            
            input.click();
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdf', file);
            
            const status = document.getElementById('status');
            status.textContent = 'Uploading...';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                status.textContent = data.success ? 'Upload successful! Redirecting...' : 'Error: ' + data.error;
                if (data.success) {
                    setTimeout(() => window.location.href = '/', 1000);
                }
            })
            .catch(error => {
                status.textContent = 'Error uploading file: ' + error;
            });
        }

        // Event Listeners
        window.addEventListener('load', () => {
            if (isMobile()) {
                document.querySelector('.drop-zone').style.display = 'none';
            }
            userInput.focus();
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        const dropZone = document.querySelector('.drop-zone');
        const dropInput = dropZone.querySelector('.drop-zone__input');

        dropZone.addEventListener('click', () => dropInput.click());
        dropInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                uploadFile(e.target.files[0]);
            }
        });

        ['dragover', 'dragleave', 'dragend', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.toggle('drop-zone--over', eventName === 'dragover');
                
                if (eventName === 'drop') {
                    const file = e.dataTransfer.files[0];
                    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/heic'];
                    
                    if (allowedTypes.includes(file.type)) {
                        uploadFile(file);
                    } else {
                        document.getElementById('status').textContent = 'Please upload a PDF or image file';
                    }
                }
            });
        });
    </script>
</body>
</html>
