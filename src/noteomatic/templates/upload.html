<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Notes</title>
    <link rel="stylesheet" href="/static/upload.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>
<body>
    <div class="container">
        <nav class="mobile-nav">
            <a href="/browse">Browse</a>
            <a href="/">Home</a>
            <a href="/tags">Tags</a>
            <a href="/search">Search</a>
            <a href="{{ url_for('logout') }}">Logout</a>
        </nav>
        <div class="welcome-message">
            Welcome, {{ current_user.name }}! You have {{ note_count }} notes.
        </div>
        <div class="upload-section">
            <div class="mobile-controls">
                <button onclick="captureImage('camera')" class="btn">
                    <img src="/static/icons/camera.svg" alt="Camera" class="btn-icon">
                    Take Photo
                </button>
                <button onclick="captureImage('library')" class="btn">
                    <img src="/static/icons/photo.svg" alt="Library" class="btn-icon">
                    Library
                </button>
                <button onclick="toggleAudioRecording()" class="btn" id="recordButton">
                    <img src="/static/icons/mic.svg" alt="Microphone" class="btn-icon" id="recordIcon">
                    <span id="recordText">Record Audio</span>
                </button>
            </div>
            <div id="audioRecorder" style="display: none;">
                <div class="recording-status">
                    <span id="recordingTime">00:00</span>
                    <div class="recording-indicator"></div>
                </div>
            </div>
            <div id="audioPlaybackContainer" style="display: none;">
                <audio id="audioPlayback" controls></audio>
            </div>

            <div class="drop-zone">
                <span class="drop-zone__prompt">Drop PDF, image, or audio file here or click to upload</span>
                <input type="file" name="pdf" class="drop-zone__input" accept=".pdf,.png,.jpg,.jpeg,.heic,.mp3,.wav,.m4a,.ogg,.webm" hidden>
            </div>
        </div>

        <div class="chat-section">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages"></div>
                <div class="chat-input">
                    <textarea id="user-input" placeholder="Ask me anything about your notes..." rows="1"></textarea>
                    <button onclick="sendMessage()" class="btn">Send</button>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || window.innerWidth <= 600;
        }

        function addMessage(message, isUser = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            if (isUser) {
                messageDiv.textContent = message;
            } else {
                const temp = document.createElement('div');
                temp.innerHTML = DOMPurify.sanitize(message);
                messageDiv.innerHTML = temp.innerHTML;
            }
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            addMessage(message);
            userInput.value = '';
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                const responseText = data.success ? data.response : 'Error: ' + data.error;
                
                // Create a temporary div to safely parse HTML
                const temp = document.createElement('div');
                temp.innerHTML = DOMPurify.sanitize(responseText);
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ai-message';
                messageDiv.innerHTML = temp.innerHTML;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                addMessage('Error sending message: ' + error, false);
            }
        }

        function captureImage(source) {
            const input = document.querySelector('.drop-zone__input');
            input.removeAttribute('capture');
            
            if (source === 'camera') {
                input.setAttribute('capture', 'environment');
            }
            
            input.click();
        }

        let mediaRecorder;
        let audioChunks = [];
        let recordingTimer;
        let recordingStartTime;
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                // Set specific options for Safari compatibility
                const options = {
                    mimeType: 'audio/webm;codecs=opus'
                };
                
                try {
                    mediaRecorder = new MediaRecorder(stream, options);
                } catch (e) {
                    // Fallback for Safari
                    mediaRecorder = new MediaRecorder(stream);
                }
                
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    try {
                        // Determine the correct MIME type
                        let mimeType = 'audio/webm';
                        if (audioChunks[0] && audioChunks[0].type) {
                            mimeType = audioChunks[0].type;
                        }
                        
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = document.getElementById('audioPlayback');
                        
                        // Add error handling for playback
                        audio.onerror = (e) => {
                            console.error('Audio playback error:', e);
                            document.getElementById('status').textContent = 
                                'Audio recorded successfully but preview not available. Processing...';
                        };
                        
                        audio.src = audioUrl;
                        document.getElementById('audioPlaybackContainer').style.display = 'block';
                        
                        // Upload the file with the correct extension
                        const extension = mimeType.includes('webm') ? 'webm' : 
                                        mimeType.includes('mp4') ? 'm4a' : 
                                        'wav';
                        uploadFile(new File([audioBlob], `recording.${extension}`, { type: mimeType }));
                    } catch (error) {
                        console.error('Error handling recorded audio:', error);
                        document.getElementById('status').textContent = 
                            'Recording completed. Processing...';
                        // Still try to upload even if playback fails
                        uploadFile(new File([new Blob(audioChunks)], 'recording.wav'));
                    }
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                updateRecordingTime();
                
                document.getElementById('audioRecorder').style.display = 'block';
                const recordIcon = document.getElementById('recordIcon');
                const recordText = document.getElementById('recordText');
                recordIcon.src = '/static/icons/stop.svg';
                recordIcon.alt = 'Stop';
                recordText.textContent = 'Stop Recording';
                recordIcon.style.filter = 'invert(27%) sepia(51%) saturate(2878%) hue-rotate(346deg) brightness(104%) contrast(97%)'; // Makes icon red
                
            } catch (err) {
                console.error('Error accessing microphone:', err);
                alert('Error accessing microphone. Please ensure you have granted permission.');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                clearInterval(recordingTimer);
                
                const recordIcon = document.getElementById('recordIcon');
                const recordText = document.getElementById('recordText');
                recordIcon.src = '/static/icons/mic.svg';
                recordIcon.alt = 'Microphone';
                recordText.textContent = 'Record Audio';
                recordIcon.style.filter = 'none';
                document.getElementById('audioPlaybackContainer').style.display = 'none';
            }
        }
        
        function toggleAudioRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        function updateRecordingTime() {
            recordingTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        function uploadFile(file) {
            const formData = new FormData();
            formData.append('pdf', file);
            
            const status = document.getElementById('status');
            status.textContent = 'Uploading...';

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                status.textContent = data.success ? 'Upload successful! Redirecting...' : 'Error: ' + data.error;
                if (data.success) {
                    setTimeout(() => window.location.href = '/', 1000);
                }
            })
            .catch(error => {
                status.textContent = 'Error uploading file: ' + error;
            });
        }

        // Event Listeners
        window.addEventListener('load', () => {
            if (isMobile()) {
                document.querySelector('.drop-zone').style.display = 'none';
            }
            userInput.focus();
        });

        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        const dropZone = document.querySelector('.drop-zone');
        const dropInput = dropZone.querySelector('.drop-zone__input');

        dropZone.addEventListener('click', () => dropInput.click());
        dropInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                uploadFile(e.target.files[0]);
            }
        });

        ['dragover', 'dragleave', 'dragend', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                dropZone.classList.toggle('drop-zone--over', eventName === 'dragover');
                
                if (eventName === 'drop') {
                    const file = e.dataTransfer.files[0];
                    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/heic'];
                    
                    if (allowedTypes.includes(file.type)) {
                        uploadFile(file);
                    } else {
                        document.getElementById('status').textContent = 'Please upload a PDF or image file';
                    }
                }
            });
        });
    </script>
</body>
</html>
